Bootstrap: docker
From: python:3.13-slim-bullseye

%labels
    Author Nolan Welch

%setup
    mkdir -p $SINGULARITY_ROOTFS/app
    cp -r ./hallmonitor $SINGULARITY_ROOTFS/app
    cp ./poetry.lock $SINGULARITY_ROOTFS/app
    cp ./pyproject.toml $SINGULARITY_ROOTFS/app
    cp ./README.md $SINGULARITY_ROOTFS/app

%post
    apt-get update && apt-get install -y --no-install-recommends \
        git \
        curl \
        build-essential \
        && rm -rf /var/lib/apt/lists/*

    # Install Poetry into a custom location
    export POETRY_HOME=/opt/poetry
    curl -sSL https://install.python-poetry.org | python3 -
    echo 'export PATH="/opt/poetry/bin:$PATH"' >> /environment
    export PATH="/opt/poetry/bin:$PATH"

    # Install project dependencies into the container
    cd /app
    poetry config virtualenvs.create false
    poetry install --no-interaction --no-ansi --without dev

    # Remove caches to save space
    rm -rf /root/.cache/pypoetry
    rm -rf /root/.cache/pip

    # Remove build tools
    apt-get purge -y --auto-remove build-essential git curl

%environment
    export PATH="/opt/poetry/bin:$PATH"
    export POETRY_VIRTUALENVS_CREATE=false
    export PYTHONNOUSERSITE=1

%runscript
    cd /app
    exec poetry run python -m hallmonitor "$@"