Bootstrap: docker
From: python:3.13-slim

%labels
    Author Nolan Welch

%setup
    mkdir -p $SINGULARITY_ROOTFS/app
    cp -r ./hallmonitor $SINGULARITY_ROOTFS/app
    cp ./pyproject.toml $SINGULARITY_ROOTFS/app
    cp ./README.md $SINGULARITY_ROOTFS/app

%post
    export DEBIAN_FRONTEND=noninteractive

    # Configure the timezone to America/New_York
    ln -fs /usr/share/zoneinfo/America/New_York /etc/localtime
    echo "America/New_York" > /etc/timezone

    # Install project dependencies into the container
    cd /app
    pip install --no-cache-dir --root-user-action=ignore .
    
    # Test-only dependencies
    pip install --no-cache-dir --root-user-action=ignore mock pluggy pytest

    # Run tests, failing the build if unsuccessful
    python -m pytest --cache-clear

    # Remove test-only dependencies
    pip uninstall --no-cache-dir --root-user-action=ignore --yes mock pluggy pytest

    # Remove pip cache to save space
    rm -rf /root/.cache/pip

    # We can remove source code to save a bit of space,
    #   since we've already installed the module.
    cd /root && rm -rf /app

%environment
    export PYTHONNOUSERSITE=1

%runscript
    exec python -m hallmonitor "$@"